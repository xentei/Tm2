<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AEP OPS CONTROL | v73 SORT FIX</title>
    <link rel="icon" type="image/png" href="https://i.ibb.co/jvvJCPKY/favicon-32x32.png">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <style>
        /* ERROR OVERLAY */
        #error-box { display: none; position: fixed; top: 0; left: 0; width: 100%; background: #900; color: #fff; padding: 20px; z-index: 10000; font-family: monospace; }

        :root {
            --bg-color: #050505; --panel-bg: #101010; --border-color: #333;
            --accent-dep: #9c27b0; --accent-arr: #ff5722; 
            --alert-color: #ff3366; --ok-color: #00ff88; --pre-color: #ccff00; --highlight-border: #ffd700;
            --consult-color: #ffb300; --cancel-color: #757575; --cancel-bg: rgba(117, 117, 117, 0.15); 
            --text-main: #ffffff; --text-dim: #888;
            --auto-rule-violet-bg: rgba(208, 0, 255, 0.15); --auto-rule-violet-border: #d000ff;
            --auto-rule-red-bg: rgba(255, 60, 60, 0.15); --auto-rule-red-border: #ff3c3c;
            --font-size-base: 14px;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            font-family: 'Inter', sans-serif; 
            font-size: var(--font-size-base);
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }

        /* HIGH CONTRAST MODE */
        body.high-contrast {
            --bg-color: #000;
            --panel-bg: #000;
            --border-color: #fff;
            filter: contrast(1.5) brightness(1.2);
        }

        /* HEADER */
        header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 5px 20px; 
            background: #000; 
            border-bottom: 2px solid var(--border-color); 
            flex-shrink: 0; 
            min-height: 50px; 
            gap: 15px;
            flex-wrap: wrap;
        }
        .brand { 
            font-family: 'JetBrains Mono'; 
            font-weight: 900; 
            font-size: 18px; 
            text-transform: uppercase; 
            color: #fff; 
            letter-spacing: 1px; 
            text-shadow: 0 0 10px rgba(156, 39, 176, 0.6);
        }
        .brand span { color: var(--accent-dep); }
        
        /* SEARCH BAR */
        .search-container {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .search-input {
            background: #1a1a1a;
            border: 1px solid #444;
            color: #fff;
            padding: 5px 10px;
            border-radius: 4px;
            font-family: 'JetBrains Mono';
            font-size: 12px;
            width: 180px;
            transition: all 0.3s;
        }
        .search-input:focus {
            outline: none;
            border-color: var(--accent-dep);
            box-shadow: 0 0 10px rgba(156, 39, 176, 0.3);
            width: 220px;
        }
        .search-input::placeholder {
            color: #666;
        }
        
        .status-board { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .stat-group { display: flex; gap: 10px; align-items: center; border-right: 1px solid #333; padding-right: 15px; }
        .stat-group:last-child { border-right: none; }
        .stat-item { display: flex; align-items: center; gap: 5px; font-family: 'JetBrains Mono'; font-size: 11px; }
        .stat-label { color: #888; font-weight: 700; letter-spacing: 0.5px; }
        .stat-value { 
            font-weight: 900; 
            font-size: 14px; 
            padding: 0 2px; 
            text-shadow: 0 0 8px currentColor, 0 2px 4px rgba(0,0,0,0.5);
        }
        .val-ok { color: var(--ok-color); }
        .val-alert { color: var(--alert-color); animation: flash-text 2s infinite ease-in-out; }
        .val-pre { color: var(--pre-color); }
        .val-neutral { color: #ffb300; }
        .clock { font-family: 'JetBrains Mono'; font-size: 20px; font-weight: 700; color: #fff; }

        /* TOOLBAR */
        .toolbar {
            display: flex;
            gap: 10px;
            padding: 5px 20px;
            background: #0a0a0a;
            border-bottom: 1px solid var(--border-color);
            align-items: center;
            flex-shrink: 0;
            flex-wrap: wrap;
        }
        .tool-btn {
            background: #1a1a1a;
            border: 1px solid #444;
            color: #fff;
            padding: 5px 12px;
            border-radius: 4px;
            font-family: 'JetBrains Mono';
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .tool-btn:hover {
            background: #333;
            border-color: #fff;
            transform: translateY(-1px);
        }
        .tool-btn.active {
            background: var(--accent-dep);
            border-color: var(--accent-dep);
        }

        /* PLATAFORMA */
        #apron-container { 
            padding: 10px 20px; 
            border-bottom: 1px solid var(--border-color); 
            background: #080808; 
            flex-shrink: 0; 
        }
        .apron-header { 
            font-size: 10px; 
            color: #666; 
            margin-bottom: 5px; 
            text-transform: uppercase; 
            font-weight: 800; 
            font-family: 'JetBrains Mono'; 
            letter-spacing: 1px; 
        }
        .apron-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); 
            gap: 5px; 
        }
        .stand { 
            height: 35px; 
            background: #1a1a1a; 
            border: 1px solid #333; 
            border-radius: 3px; 
            position: relative; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
            cursor: default; 
        }
        .stand-num { 
            position: absolute; 
            top: 1px; 
            left: 3px; 
            font-size: 9px; 
            color: #fff; 
            font-family: 'JetBrains Mono'; 
            font-weight: 900; 
            z-index: 5; 
            text-shadow: 0 0 2px #000; 
        }
        .stand-flight { 
            font-family: 'JetBrains Mono'; 
            font-weight: 700; 
            font-size: 11px; 
            color: #fff; 
            z-index: 2; 
            letter-spacing: -0.5px; 
            animation: fade-text 0.5s ease-in-out; 
        }
        @keyframes fade-text { from { opacity: 0; transform: translateY(2px); } to { opacity: 1; transform: translateY(0); } }
        .multi-indicator { 
            position: absolute; 
            bottom: 1px; 
            right: 2px; 
            font-size: 8px; 
            color: #fff; 
            font-weight: 900; 
            letter-spacing: -1px; 
        }
        .stand.occupied-dep { 
            border-color: var(--accent-dep); 
            background: rgba(156, 39, 176, 0.15); 
            cursor: pointer; 
        }
        .stand.occupied-dep .stand-flight { color: var(--accent-dep); }
        .stand.occupied-arr { 
            border-color: var(--accent-arr); 
            background: rgba(255, 87, 34, 0.15); 
            cursor: pointer; 
        }
        .stand.occupied-arr .stand-flight { color: var(--accent-arr); }
        .stand.is-pinned { 
            border: 2px solid #fff !important; 
            background: rgba(255, 255, 255, 0.2) !important; 
            transform: scale(1.08); 
            z-index: 10; 
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }
        .stand.is-pinned .stand-flight { 
            color: #fff !important; 
            text-shadow: 0 0 5px #fff; 
        }
        .stand.hot-zone { border-bottom: 2px solid var(--alert-color); }
        .stand:hover, .stand:active {
            transform: scale(1.12);
            box-shadow: 0 0 15px rgba(255,255,255,0.4);
        }

        /* LAYOUT */
        .content-split { 
            flex: 1; 
            display: flex; 
            overflow: hidden; 
            padding: 10px 20px; 
            gap: 15px; 
        }
        .main-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 15px; 
            flex: 1;
            height: 100%; 
            min-height: 0;
            transition: all 0.3s ease;
        }
        
        /* HISTORY SIDEBAR - COLAPSABLE */
        .history-sidebar {
            width: 0;
            overflow: hidden;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 15px;
            transition: width 0.3s ease, opacity 0.3s ease;
            opacity: 0;
        }
        
        .history-sidebar.visible {
            width: 280px;
            opacity: 1;
        }
        
        .history-container {
            padding: 5px;
            overflow-y: auto;
            flex: 1;
        }
        
        .history-container::-webkit-scrollbar { width: 6px; }
        .history-container::-webkit-scrollbar-track { background: #0a0a0a; }
        .history-container::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        
        .history-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 8px;
            margin-bottom: 5px;
            background: #1a1a1a;
            border-left: 3px solid #444;
            border-radius: 3px;
            font-size: 11px;
            transition: all 0.2s;
        }
        
        .history-item:hover {
            background: #252525;
            border-left-color: #fff;
            transform: translateX(2px);
        }
        
        .history-time {
            color: #666;
            font-family: 'JetBrains Mono';
            font-size: 9px;
        }
        
        .history-flight {
            font-weight: bold;
            color: #fff;
            font-family: 'JetBrains Mono';
        }
        
        .history-details {
            color: #aaa;
            font-size: 10px;
        }
        
        .history-change {
            display: flex;
            align-items: center;
            gap: 5px;
            font-family: 'JetBrains Mono';
            font-size: 10px;
        }
        
        .old-state {
            color: #666;
            text-decoration: line-through;
        }
        
        .new-state {
            font-weight: bold;
            padding: 2px 5px;
            border-radius: 3px;
        }
        
        .state-alert {
            color: #ff3366;
            background: rgba(255, 51, 102, 0.15);
        }
        
        .state-cancel {
            color: #999;
            background: rgba(100, 100, 100, 0.1);
        }
        
        .state-pre {
            color: #ccff00;
            background: rgba(204, 255, 0, 0.15);
        }
        
        .state-ok {
            color: #00ff88;
        }

        /* MAP CONTAINER - COLAPSABLE */
        #map-container { 
            width: 0;
            overflow: hidden;
            border: 1px solid var(--border-color); 
            background: #050505; 
            border-radius: 4px; 
            position: relative; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            transition: width 0.3s ease, opacity 0.3s ease;
            opacity: 0;
            flex-shrink: 0;
        }
        
        #map-container.visible {
            width: 600px;
            opacity: 1;
        }
        
        #map-container:fullscreen { 
            width: 100vw; 
            height: 100vh; 
            border: none; 
            border-radius: 0; 
            background: #000; 
        }
        
        .panel { 
            background: var(--panel-bg); 
            border: 1px solid var(--border-color); 
            border-radius: 4px; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            height: 100%; 
        }
        .panel-header { 
            padding: 8px 12px; 
            font-size: 11px; 
            font-weight: 800; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            border-bottom: 1px solid var(--border-color); 
            display: flex; 
            justify-content: space-between; 
            background: #151515; 
            align-items: center;
        }
        .ph-dep { color: var(--accent-dep); border-top: 2px solid var(--accent-dep); }
        .ph-arr { color: var(--accent-arr); border-top: 2px solid var(--accent-arr); }
        .ph-history { color: #00d4ff; border-top: 2px solid #00d4ff; }
        .table-container { flex: 1; overflow-y: auto; }
        .table-container::-webkit-scrollbar { width: 8px; }
        .table-container::-webkit-scrollbar-track { background: #0a0a0a; }
        .table-container::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }

        /* VISTAS DE MAPA */
        #view-plano { width: 100%; height: 100%; position: absolute; top:0; left:0; display: none; }
        #view-radar { width: 100%; height: 100%; position: absolute; top:0; left:0; display: block; }
        #view-radar iframe { width: 100%; height: 100%; border: none; }
        .map-btn-group { 
            position: absolute; 
            top: 10px; 
            right: 10px; 
            z-index: 9999; 
            display: flex; 
            gap: 5px; 
            flex-wrap: wrap;
        }
        .map-btn { 
            background: rgba(20, 20, 20, 0.95); 
            color: #fff; 
            border: 1px solid #555; 
            padding: 6px 10px; 
            font-family: 'JetBrains Mono'; 
            font-size: 10px; 
            cursor: pointer; 
            border-radius: 3px; 
            transition: all 0.2s; 
            backdrop-filter: blur(5px);
        }
        .map-btn:hover { 
            background: #333; 
            border-color: #fff; 
            transform: translateY(-1px);
        }

        .leaflet-image-layer { filter: invert(1) hue-rotate(180deg) brightness(0.9) contrast(1.3); }
        .custom-dot { 
            width: 16px; 
            height: 16px; 
            border-radius: 50%; 
            background-color: #222; 
            border: 2px solid #fff; 
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.8); 
            transition: all 0.3s; 
            cursor: pointer; 
        }
        .custom-dot.dep { 
            background-color: var(--accent-dep); 
            box-shadow: 0 0 10px var(--accent-dep); 
            animation: pulse 3s infinite; 
        }
        .custom-dot.arr { 
            background-color: var(--accent-arr); 
            box-shadow: 0 0 10px var(--accent-arr); 
            animation: pulse 3s infinite; 
        }
        .custom-dot.conflict { 
            background-color: var(--alert-color); 
            box-shadow: 0 0 15px var(--alert-color); 
            animation: flash 1s infinite ease-in-out; 
        }
        .custom-dot.is-selected { 
            transform: scale(1.5) !important; 
            border-color: #fff !important; 
            background-color: #fff !important; 
            box-shadow: 0 0 20px #fff !important; 
            z-index: 999 !important; 
        }
        
        .leaflet-tooltip-flight { 
            background: rgba(0, 0, 0, 0.9); 
            border: 1px solid #666; 
            color: #fff; 
            font-family: 'JetBrains Mono'; 
            font-weight: bold; 
            border-radius: 4px; 
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.8);
            transition: font-size 0.2s, padding 0.2s; 
            text-align: center;
        }
        .zoom-low .leaflet-tooltip-flight { font-size: 8px; padding: 0px 2px; line-height: 1.1; }
        .zoom-mid .leaflet-tooltip-flight { font-size: 10px; padding: 2px 4px; line-height: 1.2; }
        .zoom-high .leaflet-tooltip-flight { font-size: 13px; padding: 4px 8px; line-height: 1.3; border: 2px solid #fff; }

        @keyframes pulse { 
            0% { opacity: 1; transform: scale(1); } 
            50% { opacity: 0.8; transform: scale(1.3); } 
            100% { opacity: 1; transform: scale(1); } 
        }
        @keyframes flash { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        @keyframes flash-text { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        @keyframes flash-bg { 
            0% { background-color: rgba(255, 51, 102, 0.1); } 
            50% { background-color: rgba(255, 51, 102, 0.3); } 
            100% { background-color: rgba(255, 51, 102, 0.1); } 
        }
        .row-delayed-flash { 
            animation: flash-bg 1.5s infinite; 
            border-left: 3px solid var(--alert-color) !important; 
        }

        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        thead { position: sticky; top: 0; background-color: #151515; z-index: 10; border-bottom: 1px solid #333; }
        th { 
            text-align: left; 
            padding: 8px 10px; 
            color: #888; 
            font-size: 10px; 
            text-transform: uppercase; 
            font-weight: 700; 
            white-space: nowrap; 
        }
        td { 
            padding: 6px 10px; 
            vertical-align: middle; 
            border-bottom: 1px solid #222; 
            white-space: nowrap; 
            color: #eee; 
        }
        tbody tr { 
            transition: background 0.15s ease; 
            cursor: pointer; 
        }
        tbody tr:hover { 
            background-color: #222 !important; 
            transform: scale(1.002);
        }
        
        .row-selected { 
            background-color: rgba(255, 215, 0, 0.15) !important; 
            border-left: 3px solid var(--highlight-border) !important; 
        }
        .row-selected td { color: #fff !important; font-weight: bold; }
        .row-selected-alert { 
            background-color: rgba(255, 51, 102, 0.25) !important; 
            border-left: 3px solid var(--alert-color) !important; 
        }
        
        .row-cancelled { background-color: var(--cancel-bg); color: var(--cancel-color); }
        .row-cancelled td { color: var(--cancel-color) !important; font-style: italic; }
        .row-cancelled .flight-link { color: var(--cancel-color) !important; text-decoration: line-through; }
        
        .row-auto-violet { background-color: var(--auto-rule-violet-bg); border-left: 3px solid var(--auto-rule-violet-border); }
        .row-auto-red { background-color: var(--auto-rule-red-bg); border-left: 3px solid var(--auto-rule-red-border); }
        
        .mono { font-family: 'JetBrains Mono', monospace; }
        .bold { font-weight: 700; }
        .tail-number { 
            color: #aaa; 
            font-size: 11px; 
            border: 1px solid #444; 
            padding: 1px 4px; 
            border-radius: 2px; 
        }
        .time-est { color: #ffae00; font-weight: bold; }
        .time-real { color: #00ff88; font-weight: bold; }
        .badge { 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            padding: 1px 5px; 
            border-radius: 3px; 
            font-weight: 700; 
            font-size: 11px; 
            min-width: 25px; 
            font-family: 'JetBrains Mono'; 
        }
        .b-pos { background: #222; color: #ffd700; border: 1px solid #444; }
        .b-gate { color: var(--accent-arr); background: rgba(255, 87, 34, 0.1); }
        .b-belt { color: #fff; background: #333; }
        
        .st-pill { 
            padding: 1px 6px; 
            border-radius: 3px; 
            font-weight: 800; 
            font-size: 11px; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
        }
        .st-ok { color: #00ff88; }
        .st-pre { 
            color: #ccff00; 
            background: rgba(204, 255, 0, 0.15); 
            border: 1px solid #ccff00; 
            animation: flash-text 2s infinite ease-in-out; 
            text-shadow: 0 0 8px #ccff00; 
        }
        .st-alert-flash { 
            color: var(--alert-color); 
            background: rgba(255, 51, 102, 0.15); 
            border: 1px solid var(--alert-color); 
            animation: flash-text 2s infinite ease-in-out; 
            text-shadow: 0 0 8px var(--alert-color); 
        }
        .st-consult-flash { 
            color: var(--consult-color); 
            background: rgba(255, 179, 0, 0.15); 
            border: 1px solid var(--consult-color); 
            animation: flash-text 1.5s infinite ease-in-out; 
            text-shadow: 0 0 8px var(--consult-color); 
        }
        .st-cancel { 
            color: #999; 
            border: 1px solid #777; 
            background: rgba(100,100,100,0.1); 
        }

        .btn-table-unpin { 
            border: 1px solid var(--alert-color); 
            background: rgba(255, 0, 0, 0.1); 
            color: var(--alert-color); 
            border-radius: 3px; 
            cursor: pointer; 
            padding: 0 4px; 
            font-weight: bold; 
            font-size: 10px; 
            transition: all 0.2s;
        }
        .btn-table-unpin:hover { 
            background: var(--alert-color); 
            color: #fff; 
        }
        .flight-link { 
            text-decoration: none; 
            color: inherit; 
            cursor: pointer; 
            transition: color 0.2s; 
        }
        .flight-link:hover { 
            text-decoration: underline; 
            color: #fff; 
        }

        footer { 
            padding: 5px 20px; 
            font-family: 'JetBrains Mono'; 
            font-size: 10px; 
            color: #666; 
            background: #000; 
            border-top: 1px solid #222; 
            display: flex; 
            justify-content: space-between; 
            flex-shrink: 0; 
            align-items: center;
            gap: 10px;
        }
        .footer-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* RESPONSIVE */
        @media (max-width: 1400px) {
            .main-grid { grid-template-columns: 1fr; }
        }
        
        @media (min-width: 1920px) {
            :root { --font-size-base: 15px; }
        }
        
        @media (min-width: 3840px) {
            :root { --font-size-base: 18px; }
            .stat-value { font-size: 18px; }
            .clock { font-size: 24px; }
        }
    </style>
</head>
<body>
    <div id="error-box"></div>

    <header>
        <div class="brand"><span>‚ö°</span> METRO VUELOS</div>
        
        <div class="search-container">
            <input type="text" id="search-flights" class="search-input" placeholder="üîç Buscar vuelo..." oninput="filterFlights(this.value)">
        </div>
        
        <div class="status-board">
            <div class="stat-group">
                <div class="stat-item"><span class="stat-label">PARTIDAS DEM:</span><span class="stat-value" id="count-dep">0</span></div>
                <div class="stat-item"><span class="stat-label">ARRIBOS DEM:</span><span class="stat-value" id="count-arr">0</span></div>
            </div>
            <div class="stat-group">
                <div class="stat-item"><span class="stat-label" style="color:var(--pre-color)">PRE NAC:</span><span class="stat-value val-pre" id="pre-cab">0</span></div>
                <div class="stat-item"><span class="stat-label" style="color:var(--pre-color)">PRE INT:</span><span class="stat-value val-pre" id="pre-int">0</span></div>
            </div>
            <div class="stat-group">
                <div class="stat-item"><span class="stat-label" style="color:var(--alert-color)">POS CALIENTES:</span><span class="stat-value val-alert" id="count-hot">0</span></div>
            </div>
            <div class="stat-group">
                <div class="stat-item"><span class="stat-label">TEND. DEM:</span><span class="stat-value val-neutral" id="trend-delays">‚Üí</span></div>
                <div class="stat-item"><span class="stat-label">TEND. HOT:</span><span class="stat-value val-neutral" id="trend-hot">‚Üí</span></div>
                <div class="stat-item"><span class="stat-label">CARGA:</span><span class="stat-value val-neutral" id="traffic-load">0%</span></div>
            </div>
        </div>
        <div class="clock" id="reloj">--:--:--</div>
    </header>

    <div class="toolbar">
        <button class="tool-btn" id="btn-toggle-map" onclick="toggleMapPanel()" title="Mostrar/Ocultar Mapa">
            üó∫Ô∏è MAPA
        </button>
        <button class="tool-btn" id="btn-toggle-history" onclick="toggleHistoryPanel()" title="Mostrar/Ocultar Historial">
            üìú HISTORIAL
        </button>
        <div style="border-left: 1px solid #333; height: 20px; margin: 0 5px;"></div>
        <button class="tool-btn" onclick="toggleHighContrast()" title="Alternar contraste alto">
            üåì CONTRASTE
        </button>
        <button class="tool-btn" id="sound-btn" onclick="toggleSound()" title="Alternar alertas sonoras">
            üîá SONIDO OFF
        </button>
        <button class="tool-btn" onclick="clearAllPins()" title="Limpiar todas las selecciones">
            üóëÔ∏è LIMPIAR PINES
        </button>
        <button class="tool-btn" id="sim-btn" onclick="toggleSim()">
            üõ†Ô∏è MODO TEST
        </button>
    </div>

    <div id="apron-container">
        <div class="apron-header">POSICIONES ACTIVAS</div>
        <div class="apron-grid" id="apron-grid"></div>
    </div>

    <div class="content-split">
        <div class="main-grid">
            <div class="panel">
                <div class="panel-header ph-dep">
                    <span>üõ´ Partidas</span>
                    <span id="count-partidas-total">0</span>
                </div>
                <div class="table-container">
                    <table id="tbl-partidas">
                        <thead>
                            <tr>
                                <th>Vuelo</th>
                                <th>Dest</th>
                                <th>Fch</th>
                                <th>Prog</th>
                                <th>Est/Real</th>
                                <th>Mat</th>
                                <th>Pos</th>
                                <th>Pta</th>
                                <th>Est</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <div class="panel">
                <div class="panel-header ph-arr">
                    <span>üõ¨ Arribos</span>
                    <span id="count-arribos-total">0</span>
                </div>
                <div class="table-container">
                    <table id="tbl-arribos">
                        <thead>
                            <tr>
                                <th>Vuelo</th>
                                <th>Orig</th>
                                <th>Fch</th>
                                <th>Prog</th>
                                <th>Est/Real</th>
                                <th>Mat</th>
                                <th>Pos</th>
                                <th>Cin</th>
                                <th>Est</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="history-sidebar" id="history-sidebar">
            <div class="panel">
                <div class="panel-header ph-history">
                    <span>üìú HISTORIAL</span>
                    <button class="tool-btn" style="padding:2px 6px;font-size:9px;" onclick="clearHistory()">
                        üóëÔ∏è
                    </button>
                </div>
                <div id="history-panel" class="history-container">
                    <div style="color:#666;padding:10px;text-align:center;font-size:11px;">
                        Esperando cambios...
                    </div>
                </div>
            </div>
        </div>

        <div id="map-container">
            <div class="map-btn-group">
                <button class="map-btn" onclick="resetMap()">üîç CENTRAR AEP</button>
                <button class="map-btn" onclick="toggleFullscreen()">‚õ∂ PANTALLA COMPLETA</button>
                <button class="map-btn" id="btn-toggle-view" onclick="toggleMapView()">üó∫Ô∏è VER PLATAFORMA</button>
            </div>
            
            <div id="view-plano">
                <div id="map" style="width:100%; height:100%;"></div>
            </div>
            <div id="view-radar">
                <iframe id="radar-frame" src="https://globe.adsbexchange.com/?lat=-34.57&lon=-58.42&zoom=9&hideSidebar&hideButtons&enableLabels"></iframe>
            </div>
        </div>
    </div>

    <footer>
        <div class="footer-section">
            <div id="sys-status">üü¢ SYSTEM: ONLINE</div>
            <div>|</div>
            <div>DATA: <span id="data-ts">...</span></div>
        </div>
        <div class="footer-section">
            <div>v73 SORT FIX | Historial: <span id="history-count">0</span> cambios</div>
        </div>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // =====================================================
        // ERROR HANDLER GLOBAL
        // =====================================================
        window.onerror = function(msg, url, line) {
            const el = document.getElementById('error-box');
            if(el) { 
                el.style.display = 'block'; 
                el.innerHTML = `‚ö†Ô∏è ERROR: ${msg} (L√≠nea ${line})`; 
                setTimeout(() => el.style.display = 'none', 5000);
            }
            return false;
        };

        // =====================================================
        // UTILIDADES
        // =====================================================
        const Utils = {
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                };
            },

            padPosition(pos) { 
                if(!pos) return "---";
                return !isNaN(pos) ? parseInt(pos).toString().padStart(2, '0') : pos; 
            },

            isHotZone(pos, hotZones) { 
                const p = parseInt(pos); 
                return !isNaN(p) && hotZones.includes(p); 
            },

            isInternational(lugar, intAirports) { 
                return intAirports.includes((lugar || "").toUpperCase()); 
            },

            hasDelayStatus(estado) { 
                return /DEM|DLY/.test((estado || "").toUpperCase()); 
            },

            isCancelledStatus(estado) { 
                return /CAN/.test((estado || "").toUpperCase()); 
            },

            isPreBoardingStatus(estado) { 
                return (estado || "").toUpperCase().includes("PRE"); 
            },

            getTodayDate() { 
                return new Date().toISOString().split('T')[0]; 
            },

            // --- FUNCI√ìN DE ORDENAMIENTO MEJORADA ---
            // Crea un n√∫mero MMDDHHMM para ordenar correctamente fechas y horas
            getSortTimestamp(flight) {
                // Obtener fecha (DD/MM)
                // Si viene vac√≠a, asumimos "00/00" para que vaya al fondo, o "99/99"
                let f = flight.fecha || "99/99"; 
                let [dia, mes] = f.split('/').map(n => (n || "00").padStart(2, '0'));

                // Obtener hora (prioridad: Real > Est > Prog)
                // Como pediste, si no hay Real, usa Prog. (Aqu√≠ usamos la cascada completa por seguridad)
                let t = flight.hora_real || flight.hora_est || flight.hora_prog || "23:59";
                let tClean = t.replace(":", "").padStart(4, '0');

                // Formato comparativo: MMDDHHMM (Mes + Dia + Hora + Minuto)
                // Ejemplo: 08/12 20:30 -> 12082030
                // Ejemplo: 09/12 00:10 -> 12090010
                // Al comparar estos n√∫meros, 1208... siempre es menor que 1209...
                return parseInt(`${mes}${dia}${tClean}`);
            }
        };

        // =====================================================
        // SISTEMA DE ALERTAS SONORAS
        // =====================================================
        class AlertSystem {
            constructor() {
                this.enabled = false;
                this.audioContext = null;
            }

            init() {
                if (!this.audioContext) {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
            }

            playAlert(type) {
                if (!this.enabled) return;
                
                this.init();
                
                const frequency = {
                    critical: 880,
                    warning: 440,
                    info: 220
                }[type] || 440;

                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.15, this.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.3);
                
                oscillator.start();
                oscillator.stop(this.audioContext.currentTime + 0.3);
            }

            toggle() {
                this.enabled = !this.enabled;
                return this.enabled;
            }
        }

        // =====================================================
        // HISTORIAL DE CAMBIOS DE ESTADO
        // =====================================================
        class StateHistory {
            constructor(maxEntries = 50) {
                this.history = [];
                this.maxEntries = maxEntries;
            }

            addChange(flight, oldState, newState) {
                this.history.unshift({
                    timestamp: new Date(),
                    flight: flight.vuelo,
                    lugar: flight.lugar,
                    from: oldState,
                    to: newState,
                    posicion: flight.posicion,
                    tipo: flight._tipo
                });
                
                if (this.history.length > this.maxEntries) {
                    this.history.pop();
                }
            }

            getRecent(count = 10) {
                return this.history.slice(0, count);
            }

            clear() {
                this.history = [];
            }

            getCount() {
                return this.history.length;
            }
        }

        // =====================================================
        // ANALIZADOR DE TENDENCIAS
        // =====================================================
        class TrendAnalyzer {
            constructor(windowMinutes = 30) {
                this.windowMinutes = windowMinutes;
                this.snapshots = [];
            }

            takeSnapshot(data) {
                const now = Date.now();
                
                const snapshot = {
                    timestamp: now,
                    totalDelays: this.countDelays(data),
                    totalFlights: data.partidas.length + data.arribos.length,
                    hotPositions: this.countHotPositions(data),
                    preBoardings: this.countPreBoardings(data)
                };
                
                this.snapshots.push(snapshot);
                
                const cutoff = now - (this.windowMinutes * 60 * 1000);
                this.snapshots = this.snapshots.filter(s => s.timestamp >= cutoff);
            }

            countDelays(data) {
                return [...data.partidas, ...data.arribos]
                    .filter(f => f._state?.isDelayed).length;
            }

            countHotPositions(data) {
                return [...data.partidas, ...data.arribos]
                    .filter(f => f._state?.isHot).length;
            }

            countPreBoardings(data) {
                return data.partidas.filter(f => f._state?.isPreBoarding).length;
            }

            getTrend(metric) {
                if (this.snapshots.length < 3) return 'stable';
                
                const recent = this.snapshots.slice(-5);
                const values = recent.map(s => s[metric]);
                
                const mid = Math.floor(values.length / 2);
                const firstHalf = values.slice(0, mid);
                const secondHalf = values.slice(mid);
                
                const avgFirst = firstHalf.reduce((a, b) => a + b, 0) / firstHalf.length;
                const avgSecond = secondHalf.reduce((a, b) => a + b, 0) / secondHalf.length;
                
                const change = avgSecond - avgFirst;
                
                if (change > 0.5) return 'up';
                if (change < -0.5) return 'down';
                return 'stable';
            }

            getTrendIcon(metric) {
                const trend = this.getTrend(metric);
                return {
                    up: '‚ÜóÔ∏è',
                    down: '‚ÜòÔ∏è',
                    stable: '‚Üí'
                }[trend];
            }

            getTrendColor(metric) {
                const trend = this.getTrend(metric);
                if (metric === 'totalDelays' || metric === 'hotPositions') {
                    return {
                        up: '#ff3366',
                        down: '#00ff88',
                        stable: '#ffb300'
                    }[trend];
                }
                return {
                    up: '#00ff88',
                    down: '#ff3366',
                    stable: '#ffb300'
                }[trend];
            }

            getTrafficLoad() {
                if (this.snapshots.length === 0) return 0;
                
                const latest = this.snapshots[this.snapshots.length - 1];
                const maxCapacity = 100;
                
                return Math.round((latest.totalFlights / maxCapacity) * 100);
            }
        }

        // =====================================================
        // GESTOR DE DATOS
        // =====================================================
        class FlightDataManager {
            constructor(config) {
                this.config = config;
                this.data = { partidas: [], arribos: [] };
                this.originalData = { partidas: [], arribos: [] };
                this.cache = new Map();
            }

            async fetchData() {
                try {
                    const res = await fetch(this.config.API_URL);
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    const rawData = await res.json();
                    
                    this.originalData = this.normalizeData(rawData);
                    this.data = JSON.parse(JSON.stringify(this.originalData));
                    
                    return this.data;
                } catch (error) {
                    console.error('Error fetching data:', error);
                    throw error;
                }
            }

            normalizeData(rawData) {
                const normalize = (f, type) => {
                    let hProg = f.STA || f.STD || f.hora_prog || "";
                    if(hProg.includes(" ")) hProg = hProg.split(" ")[1];
                    
                    let hEst = f.ETA || f.ETD || f.hora_est || "";
                    if(hEst.includes(" ")) hEst = hEst.split(" ")[1];
                    
                    let hReal = f.ATA || f.ATD || f.hora_real || "";
                    if(hReal.includes(" ")) hReal = hReal.split(" ")[1];
                    
                    let fullFlight = f.vuelo || "";
                    if (!fullFlight && (f["Cia."] || f.Cia) && f.Vuelo) {
                          fullFlight = ((f["Cia."] || f.Cia) + " " + f.Vuelo).trim();
                    }
                    
                    let pos = f.Posicion || f.posicion || "---";

                    // === PROCESAMIENTO DE FECHA ===
                    let fecha = f.fecha || f.Fecha || "";

                    return {
                        vuelo: fullFlight,
                        lugar: type === 'dep' ? (f.Destino || f.lugar || "---") : (f.Origen || f.lugar || "---"),
                        fecha: fecha,
                        hora_prog: hProg,
                        hora_est: hEst,
                        hora_real: hReal,
                        matricula: f.Matricula || f.matricula || "---",
                        posicion: pos,
                        dato_extra: type === 'dep' ? (f.Puerta || f.dato_extra || "") : (f.Cinta || f.dato_extra || ""),
                        estado: f.Remark || f.estado || "",
                        _tipo: type
                    };
                };

                const filterDone = (f) => {
                    const s = (f.Remark || f.estado || "").toUpperCase();
                    return !s.includes("PAR") && !s.includes("ATE");
                };

                let partidasLimpias, arribosLimpios;
                
                if (rawData.partidas && rawData.partidas.length > 0 && rawData.partidas[0].vuelo) {
                      partidasLimpias = rawData.partidas.filter(filterDone);
                      arribosLimpios = rawData.arribos.filter(filterDone);
                } else {
                      partidasLimpias = (rawData.partidas || []).filter(filterDone).map(f => normalize(f, 'dep'));
                      arribosLimpios = (rawData.arribos || []).filter(filterDone).map(f => normalize(f, 'arr'));
                }

                return { 
                    partidas: partidasLimpias.map(f => this.enrichFlight(f)), 
                    arribos: arribosLimpios.map(f => this.enrichFlight(f))
                };
            }

            enrichFlight(flight) {
                if (this.checkAutoDelay(flight)) {
                    flight.estado = "DEM";
                    flight.isAutoDelayed = true;
                }
                return flight;
            }

            checkPreBoarding(flight) {
                if (Utils.hasDelayStatus(flight.estado) || Utils.isCancelledStatus(flight.estado)) return false;
                if (Utils.isPreBoardingStatus(flight.estado)) return true;
                
                const timeStr = flight.hora_est || flight.hora_prog;
                if (!timeStr || !timeStr.includes(':')) return false;
                
                const now = new Date();
                const [h, m] = timeStr.split(':').map(Number);
                const flightTime = new Date();
                flightTime.setHours(h, m, 0);
                
                let diff = (flightTime - now) / 60000;
                if (diff < -720) diff += 1440;
                if (diff > 720) diff -= 1440;
                
                return diff > this.config.PREBOARD_MIN && diff <= this.config.PREBOARD_MAX;
            }

            checkAutoDelay(flight) {
                const status = (flight.estado || "").toUpperCase();
                if (status.includes("PAR") || status.includes("ATE") || status.includes("CAN")) return false;
                if (Utils.hasDelayStatus(status)) return true;
                
                const timeStr = flight.hora_est || flight.hora_prog;
                if (!timeStr || !timeStr.includes(':')) return false;
                
                const now = new Date();
                const [h, m] = timeStr.split(':').map(Number);
                const flightTime = new Date();
                flightTime.setHours(h, m, 0);
                
                let diff = (flightTime - now) / 60000;
                if (diff < -5 && diff > -300) return true;
                
                return false;
            }

            getFlightState(flight) {
                const key = `${flight.vuelo}_${flight.estado}_${flight.hora_est}`;
                if (this.cache.has(key)) return this.cache.get(key);
                
                const state = {
                    isDelayed: this.checkAutoDelay(flight) || Utils.hasDelayStatus(flight.estado),
                    isPreBoarding: this.checkPreBoarding(flight),
                    isCancelled: Utils.isCancelledStatus(flight.estado),
                    isHot: Utils.isHotZone(flight.posicion, this.config.HOT_ZONES),
                    isInternational: Utils.isInternational(flight.lugar, this.config.AEROPUERTOS_INT)
                };
                
                this.cache.set(key, state);
                return state;
            }

            clearCache() {
                this.cache.clear();
            }

            resetToOriginal() {
                this.data = JSON.parse(JSON.stringify(this.originalData));
            }
        }

        // =====================================================
        // RENDERIZADOR DE UI
        // =====================================================
        class UIRenderer {
            constructor(dataManager, config, pinManager) {
                this.dataManager = dataManager;
                this.config = config;
                this.pinManager = pinManager;
            }

            renderTable(lista, tableId, type) {
                const tbody = document.querySelector(`#${tableId} tbody`);
                const fragment = document.createDocumentFragment();
                
                if (!lista || lista.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;color:#666;">Sin datos disponibles</td></tr>';
                    return;
                }

                const sortedList = [...lista].map(v => ({ 
                    ...v, 
                    id: `${v.vuelo}_${type === 'dep' ? 'D' : 'A'}`,
                    _state: this.dataManager.getFlightState(v)
                }));
                
                // === L√ìGICA DE ORDENAMIENTO ACTUALIZADA ===
                sortedList.sort((a, b) => {
                    const aPin = this.pinManager.isPinned(a.id);
                    const bPin = this.pinManager.isPinned(b.id);
                    // 1. Pines primero
                    if (aPin !== bPin) return aPin ? -1 : 1;
                    
                    // 2. Ordenar por Timestamp (MesDiaHoraMinuto)
                    // Esto asegura que 08/12 23:00 sea MENOR que 09/12 00:00
                    return Utils.getSortTimestamp(a) - Utils.getSortTimestamp(b);
                });

                sortedList.forEach(v => {
                    const tr = this.buildFlightRow(v, type);
                    fragment.appendChild(tr);
                });

                tbody.innerHTML = '';
                tbody.appendChild(fragment);
            }

            buildFlightRow(flight, type) {
                const tr = document.createElement('tr');
                const isSelected = this.pinManager.isPinned(flight.id);
                
                tr.className = this.getRowClass(flight, isSelected);
                tr.onclick = () => this.pinManager.togglePin(flight.id);
                
                tr.innerHTML = this.generateRowHTML(flight, type, isSelected);
                
                return tr;
            }

            getRowClass(flight, isSelected) {
                if (isSelected) {
                    return (flight._state.isDelayed) ? 'row-selected-alert' : 'row-selected';
                }
                if (flight._state.isCancelled) return 'row-cancelled';
                if (flight._state.isDelayed) return 'row-delayed-flash';
                if (flight._state.isHot) return 'row-auto-red';
                if (flight._state.isInternational) return 'row-auto-violet';
                return '';
            }

            generateRowHTML(flight, type, isSelected) {
                const stateClass = this.getStateClass(flight, type);
                const stateText = this.getStateText(flight, type);
                
                const estado = `<span class="st-pill ${stateClass}">${stateText}</span>`;
                const extra = type === 'dep' 
                    ? `<span class="badge b-gate">${flight.dato_extra}</span>` 
                    : `<span class="badge b-belt">C${flight.dato_extra}</span>`;
                const pos = `<span class="badge b-pos">${flight.posicion}</span>`;
                const mat = `<span class="mono tail-number">${flight.matricula}</span>`;
                
                let displayTime = `<span class="mono" style="color:#444">--:--</span>`;
                if (flight.hora_real) {
                    displayTime = `<span class="mono time-real">${flight.hora_real}</span>`;
                } else if (flight.hora_est) {
                    displayTime = `<span class="mono time-est">${flight.hora_est}</span>`;
                }

                const actionCell = isSelected 
                    ? `<td><button class="btn-table-unpin" onclick="event.stopPropagation(); APP.pinManager.unpin('${flight.id}')">‚úï</button></td>` 
                    : `<td></td>`;

                let searchUrl = `https://www.google.com/search?q=Vuelo+${flight.vuelo}`;
                if (flight.vuelo.toUpperCase().startsWith("FO")) {
                    const num = flight.vuelo.replace(/\D/g, '');
                    searchUrl = `https://flybondi.com/ar/flights?flightNo=${num}&departureDate=${Utils.getTodayDate()}`;
                }
                const flightCell = `<a href="${searchUrl}" target="_blank" class="flight-link" onclick="event.stopPropagation()">${flight.vuelo}</a>`;

                return `<td class="mono bold">${flightCell}</td>
                        <td class="font-bold">${flight.lugar}</td>
                        <td class="mono" style="color:#888; font-size:11px;">${flight.fecha || '--/--'}</td>
                        <td class="mono">${flight.hora_prog || '--:--'}</td>
                        <td>${displayTime}</td>
                        <td>${mat}</td>
                        <td>${pos}</td>
                        <td>${extra}</td>
                        <td>${estado}</td>
                        ${actionCell}`;
            }

            getStateClass(flight, type) {
                if (flight._state.isCancelled) return "st-cancel";
                if (flight._state.isDelayed) return "st-alert-flash";
                if (flight.estado && flight.estado.toUpperCase().includes("CON")) return "st-consult-flash";
                if (type === 'dep' && flight._state.isPreBoarding) return "st-pre";
                return "st-ok";
            }

            getStateText(flight, type) {
                if (type === 'dep' && flight._state.isPreBoarding && !flight._state.isDelayed) {
                    return "PRE";
                }
                return flight.estado || "";
            }

            updateHeaderStats(data) {
                const countDep = data.partidas.filter(v => v._state?.isDelayed || v.isAutoDelayed).length;
                const countArr = data.arribos.filter(v => v._state?.isDelayed || v.isAutoDelayed).length;
                
                const elDep = document.getElementById('count-dep');
                elDep.innerText = countDep;
                elDep.className = countDep > 0 ? "stat-value val-alert" : "stat-value val-ok";
                
                const elArr = document.getElementById('count-arr');
                elArr.innerText = countArr;
                elArr.className = countArr > 0 ? "stat-value val-alert" : "stat-value val-ok";
                
                let preCab = 0, preInt = 0;
                data.partidas.forEach(v => {
                    if(this.dataManager.checkPreBoarding(v)) {
                        if(Utils.isInternational(v.lugar, this.config.AEROPUERTOS_INT)) preInt++;
                        else preCab++;
                    }
                });
                document.getElementById('pre-cab').innerText = preCab;
                document.getElementById('pre-int').innerText = preInt;

                const all = [...data.partidas, ...data.arribos];
                const hotCount = all.filter(v => Utils.isHotZone(v.posicion, this.config.HOT_ZONES)).length;
                const elHot = document.getElementById('count-hot');
                elHot.innerText = hotCount;
                elHot.className = hotCount > 0 ? "stat-value val-alert" : "stat-value val-ok";

                document.getElementById('count-partidas-total').innerText = data.partidas.length;
                document.getElementById('count-arribos-total').innerText = data.arribos.length;
            }

            renderApron(data, carouselIndex) {
                const grid = document.getElementById('apron-grid');
                grid.innerHTML = '';
                
                const apronData = {};
                const all = [
                    ...data.partidas.map(f => ({...f, type:'dep', id:f.vuelo+'_D'})), 
                    ...data.arribos.map(f => ({...f, type:'arr', id:f.vuelo+'_A'}))
                ];
                
                all.forEach(f => {
                    if(f.posicion && f.posicion !== "---") {
                        const p = Utils.padPosition(f.posicion);
                        if(!apronData[p]) apronData[p] = [];
                        apronData[p].push(f);
                    }
                });

                this.config.POSICIONES_AEP.forEach(pos => {
                    const div = document.createElement('div');
                    div.className = 'stand';
                    if (Utils.isHotZone(pos, this.config.HOT_ZONES)) {
                        div.classList.add('hot-zone');
                    }
                    
                    div.innerHTML = `<span class="stand-num">${pos}</span>`;
                    
                    if (apronData[pos] && apronData[pos].length > 0) {
                        const flights = apronData[pos];
                        const index = carouselIndex % flights.length;
                        const flight = flights[index];
                        
                        div.classList.add(flight.type === 'dep' ? 'occupied-dep' : 'occupied-arr');
                        if (this.pinManager.isPinned(flight.id)) {
                            div.classList.add('is-pinned');
                        }
                        
                        const span = document.createElement('span');
                        span.className = 'stand-flight';
                        span.innerText = flight.vuelo.split(' ')[1] || flight.vuelo;
                        div.appendChild(span);
                        
                        if (flights.length > 1) {
                            const multi = document.createElement('span');
                            multi.className = 'multi-indicator';
                            multi.innerText = `√ó${flights.length}`;
                            div.appendChild(multi);
                        }
                        
                        div.onclick = () => this.pinManager.togglePin(flight.id);
                    }
                    grid.appendChild(div);
                });
            }

            renderHistory(history) {
                const container = document.getElementById('history-panel');
                if (!container) return;
                
                const recent = history.getRecent(15);
                
                if (recent.length === 0) {
                    container.innerHTML = '<div style="color:#666;padding:10px;text-align:center;font-size:11px;">Esperando cambios...</div>';
                    return;
                }
                
                const html = recent.map(h => {
                    const icon = h.tipo === 'dep' ? 'üõ´' : 'üõ¨';
                    const stateClass = this.getHistoryStateClass(h.to);
                    
                    return `
                        <div class="history-item">
                            <div class="history-time">${this.formatTime(h.timestamp)}</div>
                            <div class="history-flight">${icon} ${h.flight}</div>
                            <div class="history-details">${h.lugar} | POS ${h.posicion}</div>
                            <div class="history-change">
                                <span class="old-state">${h.from || 'OK'}</span>
                                ‚Üí
                                <span class="new-state ${stateClass}">${h.to}</span>
                            </div>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = html;
                
                document.getElementById('history-count').innerText = history.getCount();
            }

            getHistoryStateClass(state) {
                if (/DEM|DLY/.test(state)) return 'state-alert';
                if (/CAN/.test(state)) return 'state-cancel';
                if (/PRE/.test(state)) return 'state-pre';
                return 'state-ok';
            }

            formatTime(date) {
                return date.toLocaleTimeString('es-AR', { 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit' 
                });
            }
        }

        // =====================================================
        // GESTOR DE PINES
        // =====================================================
        class PinManager {
            constructor() {
                this.pinned = new Set();
            }

            togglePin(id) {
                if (this.pinned.has(id)) {
                    this.unpin(id);
                } else {
                    this.pin(id);
                }
            }

            pin(id) {
                this.pinned.add(id);
                if (APP.mapManager) {
                    APP.mapManager.syncRadar(id);
                }
                APP.refresh();
            }

            unpin(id) {
                this.pinned.delete(id);
                APP.refresh();
            }

            isPinned(id) {
                return this.pinned.has(id);
            }

            clear() {
                this.pinned.clear();
                APP.refresh();
            }

            getAll() {
                return Array.from(this.pinned);
            }
        }

        // =====================================================
        // GESTOR DE MAPA
        // =====================================================
        class MapManager {
            constructor(config, dataManager, pinManager) {
                this.config = config;
                this.dataManager = dataManager;
                this.pinManager = pinManager;
                this.map = null;
                this.markersLayer = null;
                this.currentView = 'radar';
            }

            init() {
                const imgW = 2000;
                const imgH = 1000;
                const bounds = [[0, 0], [imgH, imgW]];
                
                this.map = L.map('map', { 
                    crs: L.CRS.Simple, 
                    minZoom: -2, 
                    maxZoom: 2, 
                    zoomControl: false, 
                    attributionControl: false 
                });
                
                L.imageOverlay('https://i.ibb.co/w2VfWrC/plano.png', bounds).addTo(this.map);
                this.map.fitBounds(bounds);
                this.markersLayer = L.layerGroup().addTo(this.map);
                
                this.map.on('zoomend', () => {
                    const zoom = this.map.getZoom();
                    const container = this.map.getContainer();
                    container.classList.remove('zoom-low', 'zoom-mid', 'zoom-high');
                    if(zoom < -1) container.classList.add('zoom-low');
                    else if(zoom < 1) container.classList.add('zoom-mid');
                    else container.classList.add('zoom-high');
                });
                
                this.map.fire('zoomend');
                this.updateButtonText();
            }

            update(data, carouselIndex) {
                if (!this.map || this.currentView !== 'plano') return;
                
                this.markersLayer.clearLayers();
                
                const apronData = {};
                const all = [
                    ...data.partidas.map(f => ({...f, type:'dep', id:f.vuelo+'_D'})), 
                    ...data.arribos.map(f => ({...f, type:'arr', id:f.vuelo+'_A'}))
                ];
                
                all.forEach(f => {
                    if(f.posicion && f.posicion !== "---") {
                        const p = Utils.padPosition(f.posicion);
                        if(!apronData[p]) apronData[p] = [];
                        apronData[p].push(f);
                    }
                });

                for (const [pos, vuelos] of Object.entries(apronData)) {
                    if (this.config.COORDENADAS_POSICIONES[pos]) {
                        const coords = this.config.COORDENADAS_POSICIONES[pos];
                        const index = carouselIndex % vuelos.length;
                        const vuelo = vuelos[index];
                        
                        let className = 'custom-dot';
                        if (this.pinManager.isPinned(vuelo.id)) className += ' is-selected';
                        if (vuelos.length > 1) className += ' conflict';
                        else if (vuelo.type === 'dep') className += ' dep';
                        else className += ' arr';
                        
                        const icon = L.divIcon({ 
                            className: 'none', 
                            html: `<div class="${className}"></div>`, 
                            iconSize: [16, 16], 
                            iconAnchor: [8, 8] 
                        });
                        
                        const tooltipText = vuelos.map(v => v.vuelo).join('<br>');
                        
                        L.marker(coords, { icon: icon })
                            .bindTooltip(tooltipText, { 
                                permanent: true, 
                                direction: 'top', 
                                offset: [0, -10], 
                                className: 'leaflet-tooltip-flight' 
                            })
                            .addTo(this.markersLayer)
                            .on('click', () => { 
                                if(vuelos.length > 0) this.pinManager.togglePin(vuelos[0].id); 
                            });
                    }
                }
            }

            syncRadar(id) {
                if (this.currentView !== 'radar') return;
                
                const parts = id.split('_');
                const list = parts[1] === 'D' ? this.dataManager.data.partidas : this.dataManager.data.arribos;
                const flight = list.find(f => f.vuelo+'_'+parts[1] === id);
                
                if (flight && flight.matricula && flight.matricula !== "---") {
                    document.getElementById('radar-frame').src = 
                        `https://globe.adsbexchange.com/?reg=${flight.matricula}&zoom=9&hideSidebar&hideButtons&enableLabels`;
                }
            }

            toggleView() {
                const plano = document.getElementById('view-plano');
                const radar = document.getElementById('view-radar');
                
                if (this.currentView === 'plano') {
                    plano.style.display = 'none';
                    radar.style.display = 'block';
                    this.currentView = 'radar';
                } else {
                    radar.style.display = 'none';
                    plano.style.display = 'block';
                    this.currentView = 'plano';
                    if(this.map) {
                        this.map.invalidateSize();
                        APP.refresh();
                    }
                }
                this.updateButtonText();
            }

            updateButtonText() {
                const btn = document.getElementById('btn-toggle-view');
                if (btn) {
                    btn.innerText = (this.currentView === 'radar') ? "üó∫Ô∏è VER PLATAFORMA" : "üì° VER RADAR";
                }
            }

            reset() {
                if (this.currentView === 'plano') {
                    if(this.map) this.map.fitBounds([[0,0],[1000,2000]]);
                } else {
                    document.getElementById('radar-frame').src = 
                        "https://globe.adsbexchange.com/?lat=-34.57&lon=-58.42&zoom=9&hideSidebar&hideButtons&enableLabels";
                }
            }
        }

        // =====================================================
        // APLICACI√ìN PRINCIPAL
        // =====================================================
        class Application {
            constructor() {
                this.config = {
                    API_URL: '/datos-limpios',
                    UPDATE_INTERVAL: 15000,
                    CAROUSEL_INTERVAL: 4000,
                    PREBOARD_MIN: 30,
                    PREBOARD_MAX: 90,
                    AEROPUERTOS_INT: ["GRU", "GIG", "MVD", "SCL", "LIM", "ASU", "BOG", "FLN", "PDP", "VVI", "CWB", "POA", "MIA", "MAD"],
                    POSICIONES_AEP: ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "23", "24", "25", "26", "27", "28", "29", "30", "31", "32A", "32B"],
                    HOT_ZONES: [1, 2, 3, 4, 5, 6, 7, 8, 9, 18, 19, 20, 21],
                    COORDENADAS_POSICIONES: {
                        "01": [818, 852], "02": [783, 886], "03": [723, 953], "04": [682, 1036], "05": [644, 1076],
                        "06": [604, 1115], "07": [570, 1153], "08": [533, 1191], "09": [500, 1222], "10": [466, 1247],
                        "11": [429, 1276], "12": [396, 1291], "13": [361, 1316], "14": [325, 1337], "15": [289, 1359],
                        "16": [254, 1380], "17": [216, 1401], "18": [183, 1436], "19": [142, 1480], "20": [107, 1513],
                        "21": [71, 1530], "23": [314, 1119], "24": [348, 1093], "25": [382, 1066], "26": [461, 978],
                        "27": [482, 964], "28": [513, 927], "29": [546, 886], "30": [579, 855], "31": [611, 814],
                        "32A": [865, 893], "32B": [900, 842]
                    }
                };

                this.simMode = false;
                this.carouselIndex = 0;
                this.previousStates = new Map();

                // Componentes
                this.alertSystem = new AlertSystem();
                this.stateHistory = new StateHistory(50);
                this.trendAnalyzer = new TrendAnalyzer(30);
                this.dataManager = new FlightDataManager(this.config);
                this.pinManager = new PinManager();
                this.uiRenderer = new UIRenderer(this.dataManager, this.config, this.pinManager);
                this.mapManager = null;

                this.updateInterval = null;
                this.carouselInterval = null;
            }

            async init() {
                console.log('üöÄ Iniciando AEP OPS CONTROL v73...');
                
                this.mapManager = new MapManager(this.config, this.dataManager, this.pinManager);
                this.mapManager.init();

                await this.fetchData();

                this.startUpdateLoop();
                this.startCarouselLoop();
                this.startClockLoop();

                console.log('‚úÖ Sistema completamente operacional');
            }

            async fetchData() {
                if (this.simMode) return;

                try {
                    await this.dataManager.fetchData();
                    
                    this.dataManager.data.partidas = this.dataManager.data.partidas.map(f => ({
                        ...f,
                        _state: this.dataManager.getFlightState(f)
                    }));
                    this.dataManager.data.arribos = this.dataManager.data.arribos.map(f => ({
                        ...f,
                        _state: this.dataManager.getFlightState(f)
                    }));

                    this.detectStateChanges();
                    this.trendAnalyzer.takeSnapshot(this.dataManager.data);
                    this.updateTrendIndicators();

                    const ts = document.getElementById('data-ts');
                    if(ts) ts.innerText = new Date().toLocaleTimeString('es-AR');
                    
                    this.refresh();
                } catch (e) {
                    console.error('Error al obtener datos:', e);
                    document.getElementById('sys-status').innerHTML = 'üî¥ ERROR: Sin conexi√≥n';
                }
            }

            detectStateChanges() {
                const allFlights = [...this.dataManager.data.partidas, ...this.dataManager.data.arribos];
                
                allFlights.forEach(flight => {
                    const flightId = flight.vuelo;
                    const currentState = flight.estado;
                    
                    if (this.previousStates.has(flightId)) {
                        const oldState = this.previousStates.get(flightId);
                        
                        if (oldState !== currentState && currentState) {
                            this.stateHistory.addChange(flight, oldState, currentState);
                            
                            if (currentState === "DEM" && oldState !== "DEM") {
                                this.alertSystem.playAlert('warning');
                            } else if (currentState.toUpperCase().includes("CAN")) {
                                this.alertSystem.playAlert('critical');
                            }
                        }
                    }
                    
                    this.previousStates.set(flightId, currentState);
                });
            }

            updateTrendIndicators() {
                const delayTrend = this.trendAnalyzer.getTrendIcon('totalDelays');
                const delayColor = this.trendAnalyzer.getTrendColor('totalDelays');
                const elDelayTrend = document.getElementById('trend-delays');
                elDelayTrend.innerHTML = delayTrend;
                elDelayTrend.style.color = delayColor;
                
                const hotTrend = this.trendAnalyzer.getTrendIcon('hotPositions');
                const hotColor = this.trendAnalyzer.getTrendColor('hotPositions');
                const elHotTrend = document.getElementById('trend-hot');
                elHotTrend.innerHTML = hotTrend;
                elHotTrend.style.color = hotColor;
                
                const load = this.trendAnalyzer.getTrafficLoad();
                const loadColor = load > 80 ? '#ff3366' : load > 60 ? '#ffb300' : '#00ff88';
                const elLoad = document.getElementById('traffic-load');
                elLoad.innerHTML = `${load}%`;
                elLoad.style.color = loadColor;
            }

            refresh() {
                this.uiRenderer.updateHeaderStats(this.dataManager.data);
                this.uiRenderer.renderTable(this.dataManager.data.partidas, 'tbl-partidas', 'dep');
                this.uiRenderer.renderTable(this.dataManager.data.arribos, 'tbl-arribos', 'arr');
                this.uiRenderer.renderApron(this.dataManager.data, this.carouselIndex);
                this.uiRenderer.renderHistory(this.stateHistory);
                this.mapManager.update(this.dataManager.data, this.carouselIndex);
            }

            startUpdateLoop() {
                this.updateInterval = setInterval(() => this.fetchData(), this.config.UPDATE_INTERVAL);
            }

            startCarouselLoop() {
                this.carouselInterval = setInterval(() => {
                    this.carouselIndex++;
                    this.refresh();
                }, this.config.CAROUSEL_INTERVAL);
            }

            startClockLoop() {
                const updateClock = () => {
                    document.getElementById('reloj').innerText = 
                        new Date().toLocaleTimeString('es-AR', { hour12: false });
                };
                updateClock();
                setInterval(updateClock, 1000);
            }

            toggleSim() {
                this.simMode = !this.simMode;
                const btn = document.getElementById('sim-btn');
                
                if (this.simMode) {
                    clearInterval(this.updateInterval);
                    btn.classList.add('active');
                    
                    this.dataManager.data = {
                        partidas: [
                            { vuelo: "FO 5000", lugar: "MIA", fecha:"08/12", hora_prog: "10:00", matricula: "LV-SIM", posicion: "01", estado: "PRE", dato_extra: "12", _tipo: 'dep' },
                            { vuelo: "AR 1234", lugar: "COR", fecha:"08/12", hora_prog: "11:30", hora_est: "12:15", matricula: "LV-TST", posicion: "15", estado: "DEM", dato_extra: "8", _tipo: 'dep' },
                            { vuelo: "WJ 321", lugar: "BRC", fecha:"09/12", hora_prog: "09:00", matricula: "LV-XYZ", posicion: "20", estado: "OK", dato_extra: "5", _tipo: 'dep' }
                        ],
                        arribos: [
                            { vuelo: "AR 5678", lugar: "MDZ", fecha:"08/12", hora_prog: "13:00", hora_real: "13:05", matricula: "LV-ABC", posicion: "18", estado: "OK", dato_extra: "2", _tipo: 'arr' },
                            { vuelo: "FO 5100", lugar: "IGR", fecha:"08/12", hora_prog: "14:00", hora_est: "14:45", matricula: "LV-DEF", posicion: "3", estado: "DEM", dato_extra: "4", _tipo: 'arr' }
                        ]
                    };
                    
                    this.dataManager.data.partidas = this.dataManager.data.partidas.map(f => ({
                        ...f,
                        _state: this.dataManager.getFlightState(f)
                    }));
                    this.dataManager.data.arribos = this.dataManager.data.arribos.map(f => ({
                        ...f,
                        _state: this.dataManager.getFlightState(f)
                    }));
                    
                    setTimeout(() => {
                        if (this.simMode) {
                            this.stateHistory.addChange(
                                { vuelo: "AR 1234", lugar: "COR", posicion: "15", _tipo: 'dep' },
                                "OK",
                                "DEM"
                            );
                            this.stateHistory.addChange(
                                { vuelo: "FO 5100", lugar: "IGR", posicion: "3", _tipo: 'arr' },
                                "PRE",
                                "DEM"
                            );
                            this.refresh();
                        }
                    }, 2000);
                    
                    this.refresh();
                    alert('‚úÖ MODO TEST ACTIVADO\n\nDatos simulados cargados.\nSe simular√°n cambios de estado.');
                } else {
                    btn.classList.remove('active');
                    this.fetchData();
                    this.startUpdateLoop();
                    alert('‚úÖ MODO NORMAL\n\nConexi√≥n a datos reales restaurada.');
                }
            }
        }

        // =====================================================
        // FUNCIONES GLOBALES
        // =====================================================
        let APP;

        function toggleHighContrast() {
            document.body.classList.toggle('high-contrast');
        }

        function toggleSound() {
            const enabled = APP.alertSystem.toggle();
            const btn = document.getElementById('sound-btn');
            btn.classList.toggle('active', enabled);
            btn.innerHTML = enabled ? 'üîä SONIDO ON' : 'üîá SONIDO OFF';
        }

        function clearAllPins() {
            if (confirm('¬øLimpiar todas las selecciones?')) {
                APP.pinManager.clear();
            }
        }

        function clearHistory() {
            if (confirm('¬øLimpiar historial de cambios?')) {
                APP.stateHistory.clear();
                APP.refresh();
            }
        }

        function toggleSim() {
            APP.toggleSim();
        }

        function toggleMapView() {
            APP.mapManager.toggleView();
        }

        function resetMap() {
            APP.mapManager.reset();
        }

        function toggleFullscreen() {
            const el = document.getElementById('map-container');
            if (!document.fullscreenElement) {
                if(el.requestFullscreen) el.requestFullscreen();
            } else {
                if(document.exitFullscreen) document.exitFullscreen();
            }
        }

        // =====================================================
        // TOGGLE PANELS (COLAPSABLES)
        // =====================================================
        function toggleMapPanel() {
            const container = document.getElementById('map-container');
            const btn = document.getElementById('btn-toggle-map');
            const isVisible = container.classList.contains('visible');
            
            if (isVisible) {
                container.classList.remove('visible');
                btn.classList.remove('active');
            } else {
                container.classList.add('visible');
                btn.classList.add('active');
                // Resize del mapa despu√©s de mostrar
                setTimeout(() => {
                    if (APP.mapManager.map && APP.mapManager.currentView === 'plano') {
                        APP.mapManager.map.invalidateSize();
                    }
                }, 350);
            }
        }

        function toggleHistoryPanel() {
            const sidebar = document.getElementById('history-sidebar');
            const btn = document.getElementById('btn-toggle-history');
            const isVisible = sidebar.classList.contains('visible');
            
            if (isVisible) {
                sidebar.classList.remove('visible');
                btn.classList.remove('active');
            } else {
                sidebar.classList.add('visible');
                btn.classList.add('active');
            }
        }

        function filterFlights(query) {
            const normalized = query.toUpperCase().trim();
            
            if (!normalized) {
                APP.dataManager.resetToOriginal();
                APP.refresh();
                return;
            }

            APP.dataManager.data.partidas = APP.dataManager.originalData.partidas.filter(f => 
                f.vuelo.toUpperCase().includes(normalized) || 
                f.lugar.toUpperCase().includes(normalized) ||
                f.posicion.toUpperCase().includes(normalized) ||
                (f.matricula && f.matricula.toUpperCase().includes(normalized))
            );

            APP.dataManager.data.arribos = APP.dataManager.originalData.arribos.filter(f => 
                f.vuelo.toUpperCase().includes(normalized) || 
                f.lugar.toUpperCase().includes(normalized) ||
                f.posicion.toUpperCase().includes(normalized) ||
                (f.matricula && f.matricula.toUpperCase().includes(normalized))
            );

            APP.dataManager.data.partidas = APP.dataManager.data.partidas.map(f => ({
                ...f,
                _state: APP.dataManager.getFlightState(f)
            }));
            APP.dataManager.data.arribos = APP.dataManager.data.arribos.map(f => ({
                ...f,
                _state: APP.dataManager.getFlightState(f)
            }));

            APP.refresh();
        }

        // =====================================================
        // INICIALIZACI√ìN
        // =====================================================
        window.addEventListener('DOMContentLoaded', async () => {
            APP = new Application();
            await APP.init();
        });

    </script>
</body>
</html>
