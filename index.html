<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AEP OPS CONTROL | v12 MULTI-STAND</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700;800&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #050505;
            --panel-bg: #0f0f0f;
            --border-color: #222;
            
            /* Colores */
            --accent-dep: #ff6b00; 
            --accent-arr: #00f0ff; 
            --alert-color: #ff003c; 
            --highlight-border: #ffd700; 
            
            --auto-rule-bg: rgba(120, 80, 255, 0.08);
            --auto-rule-border: rgba(120, 80, 255, 0.6);
            
            --text-main: #e0e0e0;
            --text-dim: #555;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            margin: 0;
            height: 100%; min-height: 100vh;
            display: flex; flex-direction: column; overflow-x: hidden;
        }

        /* HEADER */
        header { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: #080808; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .brand { font-family: 'JetBrains Mono'; font-weight: 800; font-size: 18px; text-transform: uppercase; color: #fff; letter-spacing: 1px; }
        .brand span { color: var(--accent-dep); }
        .clock { font-family: 'JetBrains Mono'; font-size: 18px; font-weight: 700; color: #888; }

        /* --- MAPA DE PLATAFORMA --- */
        #apron-container { padding: 10px 15px; border-bottom: 1px solid var(--border-color); background: #0a0a0a; flex-shrink: 0; }
        .apron-header { font-size: 10px; color: #444; margin-bottom: 8px; text-transform: uppercase; font-weight: bold; font-family: 'JetBrains Mono'; letter-spacing: 2px; }
        .apron-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(55px, 1fr)); gap: 8px; }

        .stand { 
            height: 40px; background: #111; border: 1px solid #222; border-radius: 4px; position: relative; 
            display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; cursor: default;
        }
        
        .stand-num { 
            position: absolute; top: 2px; left: 4px; 
            font-size: 10px; color: #fff; font-family: 'JetBrains Mono'; font-weight: 900; 
            text-shadow: 0 1px 2px #000; opacity: 0.9; z-index: 5;
        }
        
        .stand-flight { font-family: 'JetBrains Mono'; font-weight: 700; font-size: 11px; color: #fff; z-index: 2; letter-spacing: -0.5px; }

        /* Indicador de MÃºltiples Vuelos */
        .multi-indicator {
            position: absolute; bottom: 2px; right: 2px;
            font-size: 8px; color: #fff; opacity: 0.8; letter-spacing: -1px;
        }

        /* Estados de OcupaciÃ³n */
        .stand.occupied-dep { border-color: var(--accent-dep); background: rgba(255, 107, 0, 0.1); cursor: pointer; }
        .stand.occupied-dep .stand-flight { color: var(--accent-dep); }
        
        .stand.occupied-arr { border-color: var(--accent-arr); background: rgba(0, 240, 255, 0.1); cursor: pointer; }
        .stand.occupied-arr .stand-flight { color: var(--accent-arr); }
        
        /* Zona Caliente */
        .stand.hot-zone { border-bottom: 2px solid #444; }
        .stand.hot-zone.occupied-dep { border-bottom-color: var(--accent-dep); }
        .stand.hot-zone.occupied-arr { border-bottom-color: var(--accent-arr); }

        /* ESTADO PINNED */
        .stand.is-pinned {
            border: 2px solid #fff !important;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.15) !important;
            transform: scale(1.05); z-index: 10;
        }
        .stand.is-pinned .stand-flight { color: #fff !important; text-shadow: 0 0 5px #fff; }

        /* WATCHLIST */
        #watchlist-section { display: none; padding: 10px 15px 0 15px; flex-shrink: 0; border-bottom: 1px solid #222; background: rgba(255, 215, 0, 0.01); }
        .watchlist-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding-bottom: 10px; }
        .watchlist-col { border: 1px solid rgba(255, 215, 0, 0.3); background: rgba(255,215,0,0.02); border-radius: 4px; }
        .watchlist-col.empty { visibility: hidden; display: none; }
        .watchlist-header { padding: 4px 8px; font-size: 10px; color: var(--highlight-border); font-weight: bold; font-family: 'JetBrains Mono'; text-transform: uppercase; border-bottom: 1px solid rgba(255, 215, 0, 0.1); }

        /* PANELES */
        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; flex: 1; min-height: 0; }
        .panel { background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 6px; display: flex; flex-direction: column; overflow: hidden; height: 100%; }
        .panel-header { padding: 10px 12px; font-size: 12px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; background: #111; flex-shrink: 0; }
        .ph-dep { color: var(--accent-dep); border-top: 2px solid var(--accent-dep); }
        .ph-arr { color: var(--accent-arr); border-top: 2px solid var(--accent-arr); }
        .table-container { flex: 1; overflow-y: auto; overflow-x: auto; }
        
        table { width: 100%; border-collapse: collapse; font-size: 12px; min-width: 600px; }
        thead { position: sticky; top: 0; background-color: #111; z-index: 10; border-bottom: 1px solid #222; }
        th { text-align: left; padding: 8px 10px; color: #666; font-size: 10px; text-transform: uppercase; font-weight: 600; font-family: 'Inter'; white-space: nowrap; }
        td { padding: 6px 10px; vertical-align: middle; border-bottom: 1px solid #1a1a1a; white-space: nowrap; }
        tbody tr { cursor: pointer; transition: background 0.1s; }
        tbody tr:hover { background-color: #1a1a1a; }

        /* ESTADOS DE FILA */
        .row-selected { background-color: rgba(255, 215, 0, 0.05) !important; border-left: 2px solid var(--highlight-border) !important; }
        .row-selected td { color: #fff; }
        .row-selected-alert { background-color: rgba(255, 0, 60, 0.2) !important; border-left: 2px solid var(--alert-color) !important; }
        .row-auto-highlight { background-color: var(--auto-rule-bg); border-left: 2px solid var(--auto-rule-border); }
        .row-auto-highlight td { color: #d8b4fe; font-weight: 600; }

        /* DATA STYLES */
        .mono { font-family: 'JetBrains Mono', monospace; }
        .bold { font-weight: 700; }
        .tail-number { color: #666; font-size: 11px; }
        .time-est { color: #ff9800; font-weight: bold; }
        .time-real { color: #00e676; font-weight: bold; }
        
        .badge { display: inline-flex; align-items: center; justify-content: center; padding: 2px 5px; border-radius: 3px; font-weight: 700; font-size: 11px; min-width: 25px; font-family: 'JetBrains Mono'; }
        .b-pos { background: #1a1a1a; color: #ffd700; border: 1px solid #333; }
        .b-gate { color: var(--accent-arr); }
        .b-belt { color: #fff; }
        
        .st-ok { color: #4caf50; }

        @keyframes flash-anim { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .st-pre { color: #00ff00; font-weight: 900; animation: flash-anim 0.8s infinite; text-shadow: 0 0 5px rgba(0, 255, 0, 0.6); border: 1px solid rgba(0, 255, 0, 0.4); padding: 1px 5px; border-radius: 4px; background: rgba(0, 255, 0, 0.15); }
        .st-alert-flash { color: #ff003c; font-weight: 900; animation: flash-anim 0.8s infinite; text-shadow: 0 0 5px rgba(255, 0, 60, 0.6); border: 1px solid rgba(255, 0, 60, 0.4); padding: 1px 5px; border-radius: 4px; background: rgba(255, 0, 60, 0.15); }

        footer { padding: 5px 20px; font-family: 'JetBrains Mono'; font-size: 9px; color: #444; background: #080808; border-top: 1px solid #111; display: flex; justify-content: space-between; flex-shrink: 0; }
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: #050505; }
        ::-webkit-scrollbar-thumb { background: #222; border-radius: 3px; }

        @media (max-width: 1024px) { body { height: auto; overflow-y: auto; } .main-grid { grid-template-columns: 1fr; height: auto; gap: 20px; padding: 10px; } .panel { height: 500px; } .watchlist-grid { grid-template-columns: 1fr; gap: 10px; } .watchlist-col.empty { display: none; } }
    </style>
</head>
<body>

    <header>
        <div class="brand"><span>âš¡</span> AEP OPS</div>
        <div class="clock" id="reloj">--:--:--</div>
    </header>

    <div id="apron-container">
        <div class="apron-header">POSICIONES ACTIVAS</div>
        <div class="apron-grid" id="apron-grid"></div>
    </div>

    <div id="watchlist-section">
        <div class="watchlist-grid">
            <div class="watchlist-col" id="wl-dep-container">
                <div class="watchlist-header">SALIDAS VIGILADAS</div>
                <table id="tbl-wl-dep"><tbody></tbody></table>
            </div>
            <div class="watchlist-col" id="wl-arr-container">
                <div class="watchlist-header">LLEGADAS VIGILADAS</div>
                <table id="tbl-wl-arr"><tbody></tbody></table>
            </div>
        </div>
    </div>

    <div class="main-grid">
        <div class="panel">
            <div class="panel-header ph-dep">ðŸ›« Partidas</div>
            <div class="table-container">
                <table id="tbl-partidas">
                    <thead>
                        <tr>
                            <th>Vuelo</th><th>Dest</th><th>Prog</th><th>Est/Real</th><th>Mat</th><th>Pos</th><th>Pta</th><th>Est</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <div class="panel">
            <div class="panel-header ph-arr">ðŸ›¬ Arribos</div>
            <div class="table-container">
                <table id="tbl-arribos">
                    <thead>
                        <tr>
                            <th>Vuelo</th><th>Orig</th><th>Prog</th><th>Est/Real</th><th>Mat</th><th>Pos</th><th>Cin</th><th>Est</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <footer>
        <div>SYSTEM: ONLINE</div>
        <div>DATA: <span id="data-ts">...</span></div>
    </footer>

    <script>
        const API_URL = '/datos-limpios';
        let pinnedFlights = new Set(); 
        let globalData = { partidas: [], arribos: [] };
        
        // Objeto para almacenar el estado de las posiciones (mÃºltiples vuelos)
        let apronState = {}; 
        let carouselIndex = 0; // Para rotar

        const POSICIONES_AEP = [
            "01", "02", "03", "04", "05", "06", "07", "08", "09", "10",
            "11", "12", "13", "14", "15", "16", "17", "18", "19", "20",
            "21", "26", "27", "28", "29", "30", "31", "32A", "32B", "33", "34"
        ];

        function initApronMap() {
            const grid = document.getElementById('apron-grid');
            grid.innerHTML = '';
            POSICIONES_AEP.forEach(pos => {
                const div = document.createElement('div');
                div.className = 'stand';
                if(parseInt(pos) >= 1 && parseInt(pos) <= 9) div.classList.add('hot-zone');
                div.id = `stand-${pos}`;
                div.innerHTML = `
                    <span class="stand-num">${pos}</span>
                    <span class="stand-flight"></span>
                    <span class="multi-indicator"></span>
                `;
                grid.appendChild(div);
            });
        }
        initApronMap();

        setInterval(() => {
            document.getElementById('reloj').innerText = new Date().toLocaleTimeString('es-AR', {hour12: false});
        }, 1000);

        // ROTACIÃ“N DE CARRUSEL (Cada 3 segundos)
        setInterval(() => {
            carouselIndex++;
            renderApronFromState();
        }, 3000);

        function toggleHighlight(vueloId) {
            if(!vueloId) return;
            if (pinnedFlights.has(vueloId)) pinnedFlights.delete(vueloId);
            else pinnedFlights.add(vueloId);
            refreshUI();
        }

        async function cargarDatos() {
            try {
                const res = await fetch(API_URL);
                if(!res.ok) throw new Error("Error");
                globalData = await res.json();
                document.getElementById('data-ts').innerText = new Date().toLocaleTimeString('es-AR');
                refreshUI();
            } catch (e) { console.error(e); }
        }

        function refreshUI() {
            renderTable(globalData.partidas, 'tbl-partidas', 'gate');
            renderTable(globalData.arribos, 'tbl-arribos', 'belt');
            renderWatchlist();
            prepareApronData(); // Preparar datos para el mapa
            renderApronFromState(); // Dibujar mapa
        }

        // Paso 1: Agrupar vuelos por posiciÃ³n
        function prepareApronData() {
            apronState = {}; // Reset
            
            // Procesar Partidas
            globalData.partidas.forEach(v => {
                if(v.posicion && v.posicion !== "---") {
                    let cleanPos = v.posicion.padStart(2, '0');
                    if(!apronState[cleanPos]) apronState[cleanPos] = [];
                    apronState[cleanPos].push({ ...v, type: 'dep', id: v.vuelo+'_D' });
                }
            });

            // Procesar Arribos
            globalData.arribos.forEach(v => {
                if(v.posicion && v.posicion !== "---") {
                    let cleanPos = v.posicion.padStart(2, '0');
                    if(!apronState[cleanPos]) apronState[cleanPos] = [];
                    apronState[cleanPos].push({ ...v, type: 'arr', id: v.vuelo+'_A' });
                }
            });
        }

        // Paso 2: Renderizar usando el Ã­ndice del carrusel
        function renderApronFromState() {
            // Limpiar visualmente primero
            document.querySelectorAll('.stand').forEach(s => {
                s.className = 'stand'; // Reset clases
                if(parseInt(s.id.split('-')[1]) >= 1 && parseInt(s.id.split('-')[1]) <= 9) s.classList.add('hot-zone');
                s.querySelector('.stand-flight').innerText = '';
                s.querySelector('.multi-indicator').innerText = '';
                s.onclick = null;
            });

            // Recorrer el estado
            Object.keys(apronState).forEach(pos => {
                const standDiv = document.getElementById(`stand-${pos}`);
                if(standDiv) {
                    const vuelosEnStand = apronState[pos];
                    const totalVuelos = vuelosEnStand.length;
                    
                    // Elegir quÃ© vuelo mostrar basado en el reloj
                    const vueloAMostrar = vuelosEnStand[carouselIndex % totalVuelos];
                    
                    // Aplicar estilos
                    if(vueloAMostrar.type === 'dep') standDiv.classList.add('occupied-dep');
                    else standDiv.classList.add('occupied-arr');

                    // Texto del vuelo
                    standDiv.querySelector('.stand-flight').innerText = vueloAMostrar.vuelo;

                    // Indicador de mÃºltiples vuelos (si hay mÃ¡s de 1)
                    if(totalVuelos > 1) {
                        standDiv.querySelector('.multi-indicator').innerText = 'â€¢â€¢'; // Puntos
                    }

                    // Check Pinned (Si ALGUNO de los vuelos en esa pos estÃ¡ pinned, iluminar el borde)
                    const algunoPinned = vuelosEnStand.some(f => pinnedFlights.has(f.id));
                    if(algunoPinned) {
                        standDiv.classList.add('is-pinned');
                    }

                    // Click: Alterna el vuelo que se estÃ¡ mostrando actualmente
                    standDiv.onclick = function() {
                        toggleHighlight(vueloAMostrar.id);
                    };
                }
            });
        }

        function renderTable(lista, tableId, type) {
            const tbody = document.querySelector(`#${tableId} tbody`);
            tbody.innerHTML = '';
            if (!lista) return;

            lista.forEach(v => {
                const vueloId = v.vuelo + (type === 'gate' ? '_D' : '_A');
                const isSelected = pinnedFlights.has(vueloId);
                let rowClass = '';

                if (isSelected) {
                    rowClass = /DEM|CAN|DLY/.test(v.estado) ? 'row-selected-alert' : 'row-selected';
                } else {
                    const lugar = v.lugar ? v.lugar.toUpperCase() : "";
                    const posNum = parseInt(v.posicion);
                    const esGRU = (lugar === "GRU");
                    const esZonaCaliente = (!isNaN(posNum) && posNum >= 1 && posNum <= 9);
                    if (esGRU || esZonaCaliente) rowClass = 'row-auto-highlight';
                }
                
                const tr = document.createElement('tr');
                tr.className = rowClass;
                tr.onclick = () => toggleHighlight(vueloId);
                tr.innerHTML = generateRowHTML(v, type);
                tbody.appendChild(tr);
            });
        }

        function renderWatchlist() {
            const section = document.getElementById('watchlist-section');
            const depC = document.getElementById('wl-dep-container');
            const arrC = document.getElementById('wl-arr-container');
            const tDep = document.querySelector('#tbl-wl-dep tbody');
            const tArr = document.querySelector('#tbl-wl-arr tbody');
            
            tDep.innerHTML = ''; tArr.innerHTML = '';

            const trackDep = globalData.partidas.map(v=>({...v,type:'gate',id:v.vuelo+'_D'})).filter(f=>pinnedFlights.has(f.id));
            const trackArr = globalData.arribos.map(v=>({...v,type:'belt',id:v.vuelo+'_A'})).filter(f=>pinnedFlights.has(f.id));

            if(trackDep.length===0 && trackArr.length===0) { section.style.display='none'; return; }
            else section.style.display='block';

            if(trackDep.length>0) {
                depC.classList.remove('empty');
                trackDep.forEach(v => {
                    const tr=document.createElement('tr'); tr.onclick=()=>toggleHighlight(v.id); tr.innerHTML=generateRowHTML(v,'gate'); tDep.appendChild(tr);
                });
            } else depC.classList.add('empty');

            if(trackArr.length>0) {
                arrC.classList.remove('empty');
                trackArr.forEach(v => {
                    const tr=document.createElement('tr'); tr.onclick=()=>toggleHighlight(v.id); tr.innerHTML=generateRowHTML(v,'belt'); tArr.appendChild(tr);
                });
            } else arrC.classList.add('empty');
        }

        function generateRowHTML(v, type) {
            let stCl = "st-ok";
            let estadoUpper = (v.estado || "").toUpperCase();
            if (/DEM|CAN|DLY/.test(estadoUpper)) stCl = "st-alert-flash";
            else if (estadoUpper.includes("PRE")) stCl = "st-pre";

            let extra = (v.dato_extra && v.dato_extra!=="---") ? (type==='gate'?`<span class="badge b-gate">${v.dato_extra}</span>`:`<span class="badge b-belt">C ${v.dato_extra}</span>`) : "";
            let pos = (v.posicion && v.posicion!=="---") ? `<span class="badge mono b-pos">${v.posicion}</span>` : "";
            let mat = (v.matricula && v.matricula!=="---") ? `<span class="mono tail-number">${v.matricula}</span>` : "";

            let displayTime2 = "";
            if (v.hora_real) displayTime2 = `<span class="mono time-real">${v.hora_real}</span>`;
            else if (v.hora_est) displayTime2 = `<span class="mono time-est">${v.hora_est}</span>`;
            else displayTime2 = `<span class="mono" style="color:#444">--:--</span>`;

            return `<td class="mono bold">${v.vuelo}</td><td class="bold">${v.lugar}</td><td class="mono time-prog">${v.hora_prog}</td><td>${displayTime2}</td><td>${mat}</td><td>${pos}</td><td>${extra}</td><td><span class="${stCl} mono bold">${v.estado||""}</span></td>`;
        }

        cargarDatos();
        setInterval(cargarDatos, 10000); 
    </script>
</body>
</html>